<script type="text/discourse-plugin" version="0.8">
  const PLUGIN_ID = "discourse-custom-data-explorer-dropdown";

  // Register the component for query pages
  api.modifyClass("component:data-explorer-query", {
    pluginId: PLUGIN_ID,
    
    didInsertElement() {
      this._super(...arguments);
      this._initializeCustomDropdowns();
    },

    _initializeCustomDropdowns() {
      // Wait for DOM to be fully loaded with query parameters
      Ember.run.scheduleOnce('afterRender', this, () => {
        // Get current query ID
        const queryId = this.get('query.id');
        if (!queryId) return;
        
        try {
          // Parse the JSON configuration
          const configs = JSON.parse(settings.dropdown_configurations || '[]');
          
          // Find configuration for current query
          const queryConfig = configs.find(config => parseInt(config.queryId, 10) === parseInt(queryId, 10));
          if (!queryConfig) return;
          
          // Setup the dropdown
          this._setupCustomDropdown(queryConfig);
        } catch (e) {
          console.error(`${PLUGIN_ID}: Error parsing configuration`, e);
        }
      });
    },
    
    _setupCustomDropdown(config) {
      if (!config.paramName || !config.options || !Array.isArray(config.options)) {
        console.error(`${PLUGIN_ID}: Invalid configuration`, config);
        return;
      }
      
      // Find the param input to replace
      const paramContainer = $(`#query-params-container .param-input[data-name="${config.paramName}"]`);
      if (!paramContainer.length) {
        console.error(`${PLUGIN_ID}: Could not find parameter input with name ${config.paramName}`);
        return;
      }
      
      const inputField = paramContainer.find('input');
      if (!inputField.length) {
        console.error(`${PLUGIN_ID}: Could not find input field for parameter ${config.paramName}`);
        return;
      }
      
      // Hide the original input container
      paramContainer.addClass('hidden-param-input');
      
      // Create custom dropdown
      const dropdownContainer = $('<div class="custom-dropdown-container"></div>');
      const selectElement = $('<select class="custom-param-dropdown"></select>');
      
      // Add an empty option first
      selectElement.append('<option value="">Select an option...</option>');
      
      // Add options from configuration
      config.options.forEach(option => {
        if (option.label && option.value !== undefined) {
          selectElement.append(`<option value="${option.value}">${option.label}</option>`);
        }
      });
      
      // Set current value if it matches any option
      const currentValue = inputField.val();
      if (currentValue) {
        selectElement.val(currentValue);
      }
      
      // Handle change event
      selectElement.on('change', function() {
        const selectedValue = $(this).val();
        inputField.val(selectedValue);
        
        // Trigger change event on hidden input so Discourse recognizes the change
        inputField.trigger('change');
      });
      
      // Add label and dropdown to container
      const label = paramContainer.find('label').text();
      dropdownContainer.append(`<label class="custom-dropdown-label">${label}</label>`);
      dropdownContainer.append(selectElement);
      
      // Insert dropdown after the hidden input
      paramContainer.after(dropdownContainer);
    }
  });
</script>

<style>
  .hidden-param-input {
    display: none !important;
  }
  
  .custom-dropdown-container {
    margin: 8px 0;
  }
  
  .custom-dropdown-label {
    display: block;
    margin-bottom: 4px;
    font-weight: bold;
  }
  
  .custom-param-dropdown {
    width: 100%;
    padding: 6px;
    border-radius: 3px;
    border: 1px solid var(--primary-low);
  }
</style> 